const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, StringSelectMenuBuilder, PermissionFlagsBits } = require('discord.js');
const fs = require('fs');
const path = require('path');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('staff')
        .setDescription('üõ°Ô∏è Configurer les r√¥les staff autoris√©s √† utiliser les commandes de configuration')
        .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),

    async execute(interaction) {
        try {
            // V√©rifier les permissions admin
            if (!interaction.member.permissions.has(PermissionFlagsBits.Administrator)) {
                await interaction.reply({
                    content: '‚ùå Seuls les administrateurs peuvent utiliser cette commande.',
                    ephemeral: true
                });
                return;
            }

            await this.showStaffConfig(interaction);
        } catch (error) {
            console.error('Erreur staff command:', error);
            await interaction.reply({
                content: '‚ùå Une erreur s\'est produite lors de l\'affichage de la configuration staff.',
                ephemeral: true
            });
        }
    },

    async handleButtonInteraction(interaction) {
        try {
            const action = interaction.customId.replace('staff_', '');
            
            if (action === 'add_role') {
                await this.showAddRoleSelector(interaction);
            } else if (action === 'remove_role') {
                await this.showRemoveRoleSelector(interaction);
            } else if (action === 'refresh') {
                await this.showStaffConfig(interaction);
            }
        } catch (error) {
            console.error('Erreur handleButtonInteraction:', error);
        }
    },

    async handleSelectMenuInteraction(interaction) {
        try {
            if (interaction.customId === 'staff_add_role') {
                const roleIds = interaction.values;
                await this.addStaffRole(interaction, roleIds);
            } else if (interaction.customId === 'staff_remove_role') {
                const roleIds = interaction.values;
                await this.removeStaffRole(interaction, roleIds);
            }
        } catch (error) {
            console.error('Erreur handleSelectMenuInteraction:', error);
        }
    },

    async showStaffConfig(interaction) {
        try {
            const guildId = interaction.guild.id;
            const staffConfig = this.getStaffConfig(guildId);
            
            const embed = new EmbedBuilder()
                .setColor('#5865F2')
                .setTitle('üõ°Ô∏è Configuration R√¥les Staff')
                .setDescription('G√©rez les r√¥les autoris√©s √† utiliser les commandes de configuration du bot')
                .addFields(
                    {
                        name: 'üìã R√¥les Staff Actuels',
                        value: this.formatStaffRoles(interaction.guild, staffConfig),
                        inline: false
                    },
                    {
                        name: 'üîß Commandes Concern√©es',
                        value: '`/config` ‚Ä¢ `/configeconomie` ‚Ä¢ `/autothread` ‚Ä¢ `/staff`',
                        inline: false
                    },
                    {
                        name: '‚ö†Ô∏è Important',
                        value: 'Les administrateurs ont toujours acc√®s, m√™me sans r√¥le staff configur√©.',
                        inline: false
                    }
                );

            const components = [
                new ActionRowBuilder()
                    .addComponents(
                        new StringSelectMenuBuilder()
                            .setCustomId('staff_main_menu')
                            .setPlaceholder('üõ°Ô∏è Choisir une action')
                            .addOptions([
                                {
                                    label: 'Ajouter un r√¥le staff',
                                    description: 'Ajouter un r√¥le aux autorisations staff',
                                    value: 'add_role',
                                    emoji: '‚ûï'
                                },
                                {
                                    label: 'Retirer un r√¥le staff',
                                    description: 'Retirer un r√¥le des autorisations staff',
                                    value: 'remove_role',
                                    emoji: '‚ûñ'
                                },
                                {
                                    label: 'Actualiser',
                                    description: 'Actualiser la configuration',
                                    value: 'refresh',
                                    emoji: 'üîÑ'
                                }
                            ])
                    )
            ];

            const options = {
                embeds: [embed],
                components: components,
                ephemeral: true
            };

            if (interaction.replied || interaction.deferred) {
                await interaction.editReply(options);
            } else {
                await interaction.reply(options);
            }
        } catch (error) {
            console.error('Erreur showStaffConfig:', error);
        }
    },

    async showAddRoleSelector(interaction) {
        try {
            const guildId = interaction.guild.id;
            const staffConfig = this.getStaffConfig(guildId);
            
            // R√©cup√©rer tous les r√¥les sauf @everyone et les r√¥les d√©j√† configur√©s
            const availableRoles = interaction.guild.roles.cache
                .filter(role => 
                    role.id !== interaction.guild.id && // Exclure @everyone
                    !staffConfig.roles.includes(role.id) && // Exclure les r√¥les d√©j√† configur√©s
                    !role.managed // Exclure les r√¥les g√©r√©s par des bots
                )
                .sort((a, b) => b.position - a.position)
                .first(25); // Limite Discord pour les select menus

            if (availableRoles.length === 0) {
                await interaction.reply({
                    content: '‚ùå Aucun r√¥le disponible √† ajouter. Tous les r√¥les sont d√©j√† configur√©s ou g√©r√©s par des bots.',
                    ephemeral: true
                });
                return;
            }

            const embed = new EmbedBuilder()
                .setColor('#00d4aa')
                .setTitle('‚ûï Ajouter un R√¥le Staff')
                .setDescription('S√©lectionnez un r√¥le √† ajouter aux autorisations staff');

            const components = [
                new ActionRowBuilder()
                    .addComponents(
                        new StringSelectMenuBuilder()
                            .setCustomId('staff_add_role')
                            .setPlaceholder('üõ°Ô∏è S√©lectionner un ou plusieurs r√¥les √† ajouter')
                            .setMinValues(1)
                            .setMaxValues(Math.min(availableRoles.length, 25))
                            .addOptions(
                                availableRoles.map(role => ({
                                    label: role.name,
                                    description: `${role.members.size} membres`,
                                    value: role.id,
                                    emoji: 'üõ°Ô∏è'
                                }))
                            )
                    )
            ];

            await interaction.update({
                embeds: [embed],
                components: components
            });
        } catch (error) {
            console.error('Erreur showAddRoleSelector:', error);
        }
    },

    async showRemoveRoleSelector(interaction) {
        try {
            const guildId = interaction.guild.id;
            const staffConfig = this.getStaffConfig(guildId);
            
            if (staffConfig.roles.length === 0) {
                await interaction.reply({
                    content: '‚ùå Aucun r√¥le staff configur√© √† retirer.',
                    ephemeral: true
                });
                return;
            }

            const staffRoles = staffConfig.roles
                .map(roleId => interaction.guild.roles.cache.get(roleId))
                .filter(role => role) // Enlever les r√¥les supprim√©s
                .sort((a, b) => b.position - a.position);

            const embed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle('‚ûñ Retirer un R√¥le Staff')
                .setDescription('S√©lectionnez un r√¥le √† retirer des autorisations staff');

            const components = [
                new ActionRowBuilder()
                    .addComponents(
                        new StringSelectMenuBuilder()
                            .setCustomId('staff_remove_role')
                            .setPlaceholder('üõ°Ô∏è S√©lectionner un ou plusieurs r√¥les √† retirer')
                            .setMinValues(1)
                            .setMaxValues(Math.min(staffRoles.length, 25))
                            .addOptions(
                                staffRoles.map(role => ({
                                    label: role.name,
                                    description: `${role.members.size} membres`,
                                    value: role.id,
                                    emoji: 'üóëÔ∏è'
                                }))
                            )
                    )
            ];

            await interaction.update({
                embeds: [embed],
                components: components
            });
        } catch (error) {
            console.error('Erreur showRemoveRoleSelector:', error);
        }
    },

    async addStaffRole(interaction, roleIds) {
        try {
            const guildId = interaction.guild.id;
            const staffConfig = this.getStaffConfig(guildId);
            
            const addedRoles = [];
            const alreadyExisting = [];
            
            // Traiter chaque r√¥le s√©lectionn√©
            for (const roleId of roleIds) {
                const role = interaction.guild.roles.cache.get(roleId);
                if (!role) continue;
                
                if (staffConfig.roles.includes(roleId)) {
                    alreadyExisting.push(role.name);
                } else {
                    staffConfig.roles.push(roleId);
                    addedRoles.push(role.name);
                }
            }
            
            this.saveStaffConfig(guildId, staffConfig);

            let message = '';
            if (addedRoles.length > 0) {
                message += `‚úÖ R√¥les ajout√©s aux r√¥les staff : **${addedRoles.join(', ')}**\n`;
            }
            if (alreadyExisting.length > 0) {
                message += `‚ö†Ô∏è R√¥les d√©j√† configur√©s : **${alreadyExisting.join(', ')}**`;
            }

            await interaction.reply({
                content: message || '‚ùå Aucun r√¥le valide s√©lectionn√©.',
                ephemeral: true
            });

            // Actualiser la configuration apr√®s un court d√©lai
            setTimeout(() => {
                this.showStaffConfig(interaction);
            }, 1000);
        } catch (error) {
            console.error('Erreur addStaffRole:', error);
        }
    },

    async removeStaffRole(interaction, roleIds) {
        try {
            const guildId = interaction.guild.id;
            const staffConfig = this.getStaffConfig(guildId);
            
            const removedRoles = [];
            const notFound = [];
            
            // Traiter chaque r√¥le s√©lectionn√©
            for (const roleId of roleIds) {
                const role = interaction.guild.roles.cache.get(roleId);
                const roleIndex = staffConfig.roles.indexOf(roleId);
                
                if (roleIndex === -1) {
                    notFound.push(role ? role.name : `R√¥le ${roleId.slice(-4)}`);
                } else {
                    staffConfig.roles.splice(roleIndex, 1);
                    removedRoles.push(role ? role.name : `R√¥le ${roleId.slice(-4)}`);
                }
            }
            
            this.saveStaffConfig(guildId, staffConfig);

            let message = '';
            if (removedRoles.length > 0) {
                message += `‚úÖ R√¥les retir√©s des r√¥les staff : **${removedRoles.join(', ')}**\n`;
            }
            if (notFound.length > 0) {
                message += `‚ö†Ô∏è R√¥les non configur√©s : **${notFound.join(', ')}**`;
            }

            await interaction.reply({
                content: message || '‚ùå Aucun r√¥le valide s√©lectionn√©.',
                ephemeral: true
            });

            // Actualiser la configuration apr√®s un court d√©lai
            setTimeout(() => {
                this.showStaffConfig(interaction);
            }, 1000);
        } catch (error) {
            console.error('Erreur removeStaffRole:', error);
        }
    },

    getStaffConfig(guildId) {
        const staffPath = path.join('./data', 'staff_config.json');
        let staffConfig = {};
        
        if (fs.existsSync(staffPath)) {
            staffConfig = JSON.parse(fs.readFileSync(staffPath, 'utf8'));
        }

        return staffConfig[guildId] || { roles: [] };
    },

    saveStaffConfig(guildId, config) {
        const staffPath = path.join('./data', 'staff_config.json');
        let staffConfig = {};
        
        if (fs.existsSync(staffPath)) {
            staffConfig = JSON.parse(fs.readFileSync(staffPath, 'utf8'));
        }

        staffConfig[guildId] = config;
        fs.writeFileSync(staffPath, JSON.stringify(staffConfig, null, 2));
    },

    formatStaffRoles(guild, staffConfig) {
        if (staffConfig.roles.length === 0) {
            return '‚ùå Aucun r√¥le staff configur√©';
        }

        const rolesList = staffConfig.roles
            .map(roleId => {
                const role = guild.roles.cache.get(roleId);
                return role ? `üõ°Ô∏è ${role.name} (${role.members.size} membres)` : `‚ùå R√¥le supprim√© (${roleId.slice(-4)})`;
            })
            .join('\n');

        return rolesList;
    },

    // Fonction utilitaire pour v√©rifier les permissions staff
    hasStaffPermission(member, guildId) {
        // Les administrateurs ont toujours acc√®s
        if (member.permissions.has(PermissionFlagsBits.Administrator)) {
            return true;
        }

        const staffConfig = this.getStaffConfig(guildId);
        
        // V√©rifier si l'utilisateur a un r√¥le staff
        return staffConfig.roles.some(roleId => member.roles.cache.has(roleId));
    }
};